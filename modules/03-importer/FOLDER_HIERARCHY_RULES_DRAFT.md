# 目录层级解析规则（草案 v0）

> 目标：把上传的 `folder/zip/multi-file` 的相对路径解析为“分类树（Category Tree）”，为后续题目解析与入库提供稳定的归属路径。
>
> 说明：此文档为 03-importer 的建议实现口径，最终以 99-hub 汇总/契约为准。

## 1. 输入与输出

### 输入

- 一组“文件相对路径”（相对导入根目录），示例：
  - `数学/一年级/单元1/单选.txt`
  - `英语/七年级/阅读理解/01.pdf`

### 输出

- 一棵分类树（节点包含 `name`、`path`、`children`）
- 每个文件关联到一个“叶子分类节点”（通常为其所在目录）

## 2. 路径规范化（Normalize）

对每条相对路径执行：

- 分隔符统一：将 `\` 转为 `/`
- 去除前后空白；过滤空段（例如 `a//b`）
- 忽略系统/隐藏垃圾文件：
  - `__MACOSX/**`
  - `.DS_Store`
  - `Thumbs.db`
- 仅保留“文件”项用于后续解析；目录仅用于分类树构建

## 3. 根目录折叠（Root Folder Collapse）

当满足以下条件时，折叠掉 zip/目录的“包裹层”根文件夹：

- 所有文件路径都以同一个顶层目录开头（例如都以 `题库2026/` 开头）
- 且该顶层目录下不同时存在“同级文件”（即顶层只有一个目录，没有文件）

折叠后：

- `题库2026/数学/一年级/单元1/单选.txt` → `数学/一年级/单元1/单选.txt`

## 4. 分类树构建规则（v0：路径段即分类）

### 规则

- 对每个文件路径取其“目录段”（不含文件名），按顺序创建/复用分类节点：
  - `数学/一年级/单元1/单选.txt` → 分类路径：`数学` → `一年级` → `单元1`
- 若文件位于根目录（无目录段），归入默认分类：`未分类`

### 节点标识（建议）

为便于幂等与去重，节点可用“规范化后的分类 path”作为稳定标识：

- `path`: `数学/一年级/单元1`
- `id`: `sha1(path)` 或后端自增（由 02/99-hub 定）

## 5. 示例

输入文件：

- `数学/一年级/单元1/单选.txt`
- `数学/一年级/单元1/判断.txt`
- `数学/一年级/单元2/多选.txt`
- `英语/七年级/阅读理解/01.pdf`
- `说明.txt`（根目录）

输出分类树（示意）：

- `数学`
  - `一年级`
    - `单元1`
    - `单元2`
- `英语`
  - `七年级`
    - `阅读理解`
- `未分类`

文件归属：

- `说明.txt` → `未分类`
- `数学/一年级/单元1/单选.txt` → `数学/一年级/单元1`

## 6. 待对齐问题（写入 99-hub）

- 分类节点在后端数据模型中的字段：是否需要 `type`（科目/年级/章节）或仅存 `path`
- 是否允许同名节点出现在不同父节点（建议允许）
- “根目录折叠”的启用条件与前端提示文案
- `未分类` 是否需要（以及命名）
